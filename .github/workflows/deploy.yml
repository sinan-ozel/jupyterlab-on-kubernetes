name: Deploy Basic Server for Testing

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "Select the cloud provider"
        required: true
        type: choice
        options:
          - aws
          - exoscale

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      CLUSTER_NAME: hello-k8s
      NAMESPACE: default
      REPO: sinan-ozel/iac-private

    steps:
    - name: Create working directories
      run: |
        mkdir -p repo
        mkdir -p iac

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        path: repo

    - name: Authenticate to GitHub
      run: |
        gh auth login --with-token <<< "${{ secrets.PERSONAL_ACCESS_TOKEN }}"


    - name: Download latest pulumi stack outputs artifact
      working-directory: iac
      run: |
        gh run download --repo ${{ env.REPO }} --name pulumi-${{ inputs.provider }}-${{ env.CLUSTER_NAME}}
        ls -al
        cat ${{ env.CLUSTER_NAME}}.json

    - name: Connect to Kubernetes
      run: |
        # Use pulumi-stack-outputs to configure kubectl
        kubectl config set-cluster cluster --server=iac/${{ env.CLUSTER_NAME}}.json | jq -r '.kubeconfig.server'
        kubectl config set-credentials user --token=iac/${{ env.CLUSTER_NAME}}.json | jq -r '.kubeconfig.token'
        kubectl config set-context context --cluster=cluster --user=user
        kubectl config use-context context

    - name: List Kubernetes nodes for debugging
      run: |
        kubectl get nodes -o wide