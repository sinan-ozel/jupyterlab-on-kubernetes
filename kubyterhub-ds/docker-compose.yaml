services:
  jupyterhub:
    image: kubyterhub-ds:${KUBYTERHUB_DS_VERSION:-25.12}
    container_name: jupyterhub-server
    ports:
      - "8000:8000"
      - "8081:8081"
    volumes:
      - ./jupyterhub_config.py:/etc/jupyterhub/jupyterhub_config.py
      - ./userlist.txt:/etc/jupyterhub/userlist.txt
      - ./data:/home/jovyan/work
      - ~/.ssh:/home/jovyan/.ssh:ro
      # For persistent JupyterHub database and settings
      - ./data/jupyterhub:/srv/jupyterhub
    environment:
      - JUPYTERHUB_CRYPT_KEY=${JUPYTERHUB_CRYPT_KEY:-$(openssl rand -hex 32)}
      # GitHub OAuth settings - set these in your .env file or environment
      - GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID:-}
      - GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET:-}
      # Hub URL components (for flexible deployment)
      - HUB_PROTOCOL=${HUB_PROTOCOL:-http}
      - HUB_HOST=${HUB_HOST:-localhost}
      - HUB_PORT=${HUB_PORT:-8000}
      # Or override with full URL
      - OAUTH_CALLBACK_URL=${OAUTH_CALLBACK_URL:-}
    # Uses the new startup script that creates users first
    # command: ["/usr/local/bin/start-jupyterhub.sh"]  # This is now the default CMD

  redis:
    image: redis:7.4.1-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes

  qdrant:
    image: qdrant/qdrant:v1.16.1
    container_name: qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__HTTP_PORT=6333

volumes:
  redis_data:
  qdrant_data: